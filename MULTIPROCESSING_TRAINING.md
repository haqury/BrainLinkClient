# üîÑ –û–±—É—á–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø—Ä–æ—Ü–µ—Å—Å–µ

## üìã –ü—Ä–æ–±–ª–µ–º–∞

–û–±—É—á–µ–Ω–∏–µ ML –º–æ–¥–µ–ª–∏ –≤—ã–∑—ã–≤–∞–ª–æ **–∑–∞–≤–∏—Å–∞–Ω–∏–µ UI**, –¥–∞–∂–µ –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ QThread. –≠—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏–ª–æ –ø–æ—Ç–æ–º—É, —á—Ç–æ:
- sklearn –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –≤—Å–µ —è–¥—Ä–∞ CPU
- Python GIL (Global Interpreter Lock) –±–ª–æ–∫–∏—Ä—É–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
- –î–∞–∂–µ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ UI –º–æ–∂–µ—Ç –∑–∞–≤–∏—Å–∞—Ç—å

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

–û–±—É—á–µ–Ω–∏–µ —Ç–µ–ø–µ—Ä—å –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ **–æ—Ç–¥–µ–ª—å–Ω–æ–º –ø—Ä–æ—Ü–µ—Å—Å–µ Python** (multiprocessing), –∫–æ—Ç–æ—Ä—ã–π:
- ‚úÖ –ü–æ–ª–Ω–æ—Å—Ç—å—é –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω –æ—Ç –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞
- ‚úÖ –ù–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç UI
- ‚úÖ –ú–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤—Å–µ —è–¥—Ä–∞ CPU –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π
- ‚úÖ –ù–µ –≤–ª–∏—è–µ—Ç –Ω–∞ —Ä–∞–±–æ—Ç—É –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

---

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –î–æ (QThread):
```
Main Process (UI)
    ‚îî‚îÄ‚îÄ QThread (–æ–±—É—á–µ–Ω–∏–µ)
        ‚îî‚îÄ‚îÄ sklearn.fit() ‚Üí –ë–õ–û–ö–ò–†–£–ï–¢ UI ‚ùå
```

### –ü–æ—Å–ª–µ (multiprocessing):
```
Main Process (UI)
    ‚îî‚îÄ‚îÄ Process (–æ–±—É—á–µ–Ω–∏–µ) ‚Üê –û—Ç–¥–µ–ª—å–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å Python
        ‚îî‚îÄ‚îÄ sklearn.fit() ‚Üí –ù–ï –±–ª–æ–∫–∏—Ä—É–µ—Ç UI ‚úÖ
```

---

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –§—É–Ω–∫—Ü–∏—è –æ–±—É—á–µ–Ω–∏—è –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ

**–§–∞–π–ª:** `services/ml_trainer_service.py`

```python
def _train_model_in_process(training_data_json: str, config_dict: dict, result_queue: Queue):
    """
    –û–±—É—á–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø—Ä–æ—Ü–µ—Å—Å–µ
    
    Args:
        training_data_json: JSON —Å—Ç—Ä–æ–∫–∞ —Å training data
        config_dict: –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –º–æ–¥–µ–ª–∏
        result_queue: Queue –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –æ–±—Ä–∞—Ç–Ω–æ
    """
    # –û–±—É—á–µ–Ω–∏–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –∑–¥–µ—Å—å
    # –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è —á–µ—Ä–µ–∑ Queue
```

### –ó–∞–ø—É—Å–∫ –ø—Ä–æ—Ü–µ—Å—Å–∞

```python
# –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–∞
self._training_process = Process(
    target=_train_model_in_process,
    args=(training_data_json, config_dict, self._result_queue)
)

# –ó–∞–ø—É—Å–∫
self._training_process.start()

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —á–µ—Ä–µ–∑ QTimer
self._result_timer.timeout.connect(self._check_process_result)
```

### –ü–æ–ª—É—á–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

```python
def _check_process_result(self):
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∏–∑ –ø—Ä–æ—Ü–µ—Å—Å–∞"""
    if not self._result_queue.empty():
        result_type, result_data = self._result_queue.get()
        
        if result_type == 'success':
            # –ó–∞–≥—Ä—É–∑–∏—Ç—å –º–æ–¥–µ–ª—å –∏–∑ –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
            # –û–±–Ω–æ–≤–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            self._on_training_completed(result_data)
```

---

## üìä –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

- **–ù–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç UI** - –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –æ—Å—Ç–∞—ë—Ç—Å—è –æ—Ç–∑—ã–≤—á–∏–≤—ã–º
- **–ò—Å–ø–æ–ª—å–∑—É–µ—Ç –≤—Å–µ —è–¥—Ä–∞ CPU** - –æ–±—É—á–µ–Ω–∏–µ –±—ã—Å—Ç—Ä–µ–µ
- **–ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ø–∞–º—è—Ç—å** - –Ω–µ –≤–ª–∏—è–µ—Ç –Ω–∞ –æ—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ—Ü–µ—Å—Å

### –ù–∞–¥—ë–∂–Ω–æ—Å—Ç—å

- **–ò–∑–æ–ª—è—Ü–∏—è –æ—à–∏–±–æ–∫** - –æ—à–∏–±–∫–∏ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –Ω–µ –∫—Ä–∞—à–∞—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞** - –ø—Ä–æ—Ü–µ—Å—Å –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- **–û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–±–æ–µ–≤** - fallback –Ω–∞ rule-based –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö

---

## ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏

### Windows

–ù–∞ Windows –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `spawn` –º–µ—Ç–æ–¥ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ—Ü–µ—Å—Å–æ–≤:

```python
if sys.platform == 'win32':
    multiprocessing.set_start_method('spawn', force=True)
```

–≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—É—é —Ä–∞–±–æ—Ç—É –Ω–∞ Windows.

---

## üîÑ –ü—Ä–æ—Ü–µ—Å—Å –æ–±—É—á–µ–Ω–∏—è

### 1. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö

```python
# Training data ‚Üí JSON
training_data_json = json.dumps(data_list)

# Config ‚Üí Dict
config_dict = {...}
```

### 2. –ó–∞–ø—É—Å–∫ –ø—Ä–æ—Ü–µ—Å—Å–∞

```python
process = Process(target=_train_model_in_process, args=(...))
process.start()
```

### 3. –û–±—É—á–µ–Ω–∏–µ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ

- –ü–∞—Ä—Å–∏–Ω–≥ –¥–∞–Ω–Ω—ã—Ö
- –°–æ–∑–¥–∞–Ω–∏–µ –º–æ–¥–µ–ª–∏
- –û–±—É—á–µ–Ω–∏–µ (`model.fit()`)
- –û—Ü–µ–Ω–∫–∞ –º–µ—Ç—Ä–∏–∫
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏ –≤–æ –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª

### 4. –ü–µ—Ä–µ–¥–∞—á–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

```python
# –ß–µ—Ä–µ–∑ Queue
result_queue.put(('success', metrics))
# –∏–ª–∏
result_queue.put(('error', error_msg))
```

### 5. –ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏

```python
# –ò–∑ –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
with open(temp_path, 'rb') as f:
    model = pickle.load(f)

# –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ –º–µ—Å—Ç–æ
# –£–¥–∞–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
```

---

## üêõ Troubleshooting

### –ü—Ä–æ—Ü–µ—Å—Å –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è

**–ü—Ä–æ–±–ª–µ–º–∞:** `RuntimeError: context has already been set`

**–†–µ—à–µ–Ω–∏–µ:** –£–∂–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `force=True` –≤ `set_start_method()`

### –ú–æ–¥–µ–ª—å –Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è

**–ü—Ä–æ–±–ª–µ–º–∞:** –í—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω

**–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –Ω–∞ –æ—à–∏–±–∫–∏. –í—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª –¥–æ–ª–∂–µ–Ω —Å–æ–∑–¥–∞–≤–∞—Ç—å—Å—è –≤ `tempfile.gettempdir()`

### –ü—Ä–æ—Ü–µ—Å—Å –∑–∞–≤–∏—Å–∞–µ—Ç

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–æ—Ü–µ—Å—Å –Ω–µ –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è

**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–ª–µ–Ω —Ç–∞–π–º–∞—É—Ç –∏ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ:

```python
if process.is_alive():
    process.terminate()
    process.join(timeout=2.0)
    if process.is_alive():
        process.kill()
```

---

## üìà –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### –î–æ (QThread):
- UI –∑–∞–≤–∏—Å–∞–µ—Ç –Ω–∞ 2-10 —Å–µ–∫—É–Ω–¥
- –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤–æ –≤—Ä–µ–º—è –æ–±—É—á–µ–Ω–∏—è

### –ü–æ—Å–ª–µ (multiprocessing):
- UI –æ—Å—Ç–∞—ë—Ç—Å—è –æ—Ç–∑—ã–≤—á–∏–≤—ã–º
- –ú–æ–∂–Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å —Ä–∞–±–æ—Ç—É –≤–æ –≤—Ä–µ–º—è –æ–±—É—á–µ–Ω–∏—è
- –û–±—É—á–µ–Ω–∏–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –¥–∞–∂–µ –±—ã—Å—Ç—Ä–µ–µ (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç –≤—Å–µ —è–¥—Ä–∞)

---

## üîÆ –ë—É–¥—É—â–∏–µ —É–ª—É—á—à–µ–Ω–∏—è

- [ ] –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä —Å —Ä–µ–∞–ª—å–Ω—ã–º –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º (—á–µ—Ä–µ–∑ Queue)
- [ ] –û—Ç–º–µ–Ω–∞ –æ–±—É—á–µ–Ω–∏—è (terminate process)
- [ ] –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–µ –æ–±—É—á–µ–Ω–∏–µ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –º–æ–¥–µ–ª–µ–π
- [ ] –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø–∞–º—è—Ç–∏ (streaming –¥–∞–Ω–Ω—ã—Ö)

---

**–í–µ—Ä—Å–∏—è:** 1.0  
**–î–∞—Ç–∞:** 20.01.2026  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ
